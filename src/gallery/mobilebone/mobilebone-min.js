(function(a,b){if(typeof define==="function"&&(define.amd||define.cmd)){define("mobilebone",function(c){return b(a,c)})}else{a.Mobilebone=b(a,{})}})(this,function(f,b){var h={};var d=[];var g=d.slice;var e=/^.[^:#\[\.,]*$/;var i="pushState" in history&&"replaceState" in history&&!(window.navigator.userAgent.indexOf("Firefox")>=0&&window.top!==window)&&(window.navigator.userAgent.search(/CriOS/)===-1);b.support=i;if(i==false){return b}var a=false;b.VERSION="1.1.6";b.captureLink=true;b.rootTransition=f;b.mergeCallback=true;b.classPage="page";b.classMask="mask";b.pushStateEnabled=true;b.transition=function(j,v,s,z){if(arguments.length==0||j==v){return}if(arguments.length==3&&isNaN(s*1)==true){z=s;s=false}v=v||null,s=s||false,z=z||{};var o={root:this.rootTransition,form:this.form||"slide",onpagefirstinto:this.onpagefirstinto,animationstart:this.animationstart,animationend:this.animationend,fallback:this.fallback,callback:this.callback},n=function(B){if(!B||!B.getAttribute){return{}}var A={},C=c(B.getAttribute("data-params")||"");["title","root","form"].forEach(function(D){A[D]=B.getAttribute("data-"+D)||C[D]||z[D]||o[D]});if(typeof A.root=="string"){A.root=b.getFunction(A.root)}["onpagefirstinto","callback","fallback","animationstart","animationend"].forEach(function(D){if(b.mergeCallback==true&&typeof o[D]=="function"){var E=B.getAttribute("data-"+D)||C[D];if(typeof A.root[E]=="function"){A[D]=function(){o[D].apply(null,arguments);A.root[E].apply(null,arguments)}}else{if(typeof z[D]=="function"){A[D]=function(){o[D].apply(null,arguments);z[D].apply(null,arguments)}}else{A[D]=o[D]}}}else{A[D]=B.getAttribute("data-"+D)||C[D]||z[D]||o[D]}});return A};var m=n(v),q=n(j);if(v!=null&&v.classList){v.classList.add("out");v.classList.add(m.form);v.classList.remove("in");v.classList[s?"add":"remove"]("reverse");var u=m.fallback;if(typeof u=="string"){u=m.root[u]}if(typeof u=="function"){u(j,v,z.response)}}if(j!=null&&j.classList){var x=q.title,t=document.querySelector("h1"),l=document.querySelector("."+this.classPage);if(x){document.title=x;if(t){t.innerHTML=x;t.title=x}}else{if(l==j&&!v&&document.title){j.setAttribute("data-title",document.title)}}var k=z.id||j.id;if(h[k]&&h[k]!=j){h[k].parentElement.removeChild(h[k]);delete h[k]}j.style.display="block";j.clientWidth;j.classList.remove("out");j.classList.add("in");v&&j.classList.add(q.form);j.classList[s?"add":"remove"]("reverse");var w=q.onpagefirstinto;if(!h[k]){if(typeof w=="string"&&q.root[w]){q.root[w](j,v,z.response)}else{if(typeof w=="function"){w(j,v,z.response)}}}var r="WebkitAppearance" in document.documentElement.style||typeof document.webkitHidden!="undefined";["animationstart","animationend"].forEach(function(D,C){var A=q[D],E="webkit"+D.replace(/^a|s|e/g,function(F){return F.toUpperCase()});if(!h[k]){var B=r?E:D;C&&j.addEventListener(B,function(){if(this.classList.contains("in")==false){this.style.display="none"}});if(typeof A=="string"&&q.root[A]){j.addEventListener(B,function(){q.root[A](this,this.classList.contains("in")?"into":"out")})}else{if(typeof A=="function"){j.addEventListener(B,function(){A(this,this.classList.contains("in")?"into":"out")})}}}});var p=k;if(p&&/^#/.test(p)==false){p="#"+p}if(i&&this.pushStateEnabled&&z.history!==false&&p){history[v?"pushState":"replaceState"](null,document.title,p.replace(/^#/,"#&"))}if(!h[k]){h[k]=j}var y=q.callback;if(typeof y=="string"){y=q.root[y]}if(typeof y=="function"){y(j,v,z.response)}}};b.getCleanUrl=function(n,m,p){var k="",j="",o="";if(n){if(n.nodeType==1){k=n.getAttribute("href");j=n.getAttribute("data-formdata")||n.getAttribute("data-data")}else{if(n.url){k=n.url;j=n.data}}}if(!(k=k||m)){return""}j=j||p||"";if(typeof j=="object"){var l=[];for(key in p){l.push(key+"="+encodeURIComponent(p[key]))}if(l.length>0){j=l.join("&")}else{j=""}}o=k.split("#")[0].replace(/&+$/,"");if(o.slice(-1)=="?"){o=o.split("?")[0]}if(j!=""){if(/\?/.test(o)){j=j.replace(/^&|\?/,"");o=o+"&"+j}else{if(j!=""){j=j.replace("?","");o=o+"?"+j}}}return o};b.createPage=function(q,o,r){var l=null;if(!q){return}r=r||{};var p=document.querySelector(".in."+this.classPage);var k;if(o){if(o.nodeType==1){if(o.href){k=o.getAttribute("data-title")||r.title}l=r.response}else{l=o.response||r.response;k=o.title||r.title}}var m=null;var n=document.createElement("div");if(typeof q=="string"){n.innerHTML=q}else{n.appendChild(q)}var j=n.getElementsByTagName("title")[0];if(!(m=n.querySelector("."+this.classPage))){n.className="page out";if(typeof k=="string"){n.setAttribute("data-title",k)}m=n}else{if(j){m.setAttribute("data-title",j.innerText)}else{if(typeof k=="string"){m.setAttribute("data-title",k)}}}document.body.appendChild(m);n=null;this.transition(m,p,{response:l||q,id:this.getCleanUrl(o)||m.id||("unique"+Date.now())})};b.getFunction=function(m){if(typeof m!="string"){return}var j=f,l=m.split(".");for(var k=0;k<l.length;k+=1){if(!(j=j[l[k]])){break}}return j};b.ajax=function(l){if(!l){return}var n={url:"",dataType:"",data:{},timeout:10000,async:true,username:"",password:"",success:function(){},error:function(){},complete:function(){}};var p={},j=null;var k={},m;if(l.nodeType==1){k=c(l.getAttribute("data-params")||"");for(key in n){p[key]=l.getAttribute("data-"+key)||k[key]||n[key];if(typeof n[key]=="function"&&typeof p[key]=="string"){p[key]=this.getFunction(p[key]);if(typeof p[key]!="function"){p[key]=n[key]}}}p.url=this.getCleanUrl(l,p.url);m=l.getAttribute("data-mask");if(m=="true"||m==""){j=l.querySelector("."+this.classMask)}}else{if(l.url){for(key2 in n){p[key2]=l[key2]||n[key2]}p.url=this.getCleanUrl(null,p.url,p.data);p.title=l.title}else{return}}if(typeof m!="string"){j=document.querySelector("body > ."+this.classMask)}if(j==null){j=document.createElement("div");j.className=this.classMask;j.innerHTML='<i class="loading"></i>';if(typeof m=="string"){l.appendChild(j)}else{document.body.appendChild(j)}}j.style.visibility="visible";var o=new XMLHttpRequest();o.open("GET",p.url+(/\?/.test(p.url)?"&":"?")+"r="+Date.now(),p.async,p.username,p.password);o.timeout=p.timeout;o.onload=function(){var q=null;if(o.status==200){if(p.dataType=="json"||p.dataType=="JSON"){try{q=JSON.parse(o.response);p.response=q;b.createPage(b.jsonHandle(q),l,p)}catch(r){p.message="JSON parse error\uff1a"+r.message;p.error.call(p,o,o.status)}}else{if(p.dataType=="unknown"){try{q=JSON.parse(o.response);p.response=q;b.createPage(b.jsonHandle(q),l,p)}catch(r){q=o.response;b.createPage(q,l,p)}}else{q=o.response;b.createPage(q,l,p)}}p.success.call(p,q,o.status)}else{p.message="The status code exception!";p.error.call(p,o,o.status)}p.complete.call(p,o,o.status);j.style.visibility="hidden"};o.onerror=function(q){p.message="Illegal request address or an unexpected network error!";p.error.call(p,o,o.status);j.style.visibility="hidden"};o.ontimeout=function(){p.message="The request timeout!";p.error.call(p,o,o.status);j.style.visibility="hidden"};o.send(null)};b.isBack=function(k,l){var m=-1,j=-1;if(history.tempBack==true){j=0}else{g.call(document.querySelectorAll("."+b.classPage)).forEach(function(o,n){if(o==k){m=n}else{if(o==l){j=n}}})}history.tempBack=null;return m<j};b.jsonHandle=function(j){return'<p style="text-align:center;">Dear master, if you see me, show that JSON parsing function is undefined!</p>'},b.init=function(){if(a==true){return"Don't repeat initialization!"}var l=location.hash.replace("#&","#"),m=null;if(l==""||l=="#"){this.transition(document.querySelector("."+this.classPage))}else{if(e.test(l)==true&&(m=document.querySelector(l))&&m.classList.contains(this.classPage)){this.transition(m)}else{this.ajax({url:l.replace("#",""),dataType:"unknown",error:function(){m=document.querySelector("."+b.classPage);b.transition(m)}})}}var j="click",k=f.$||f.jQuery||f.Zepto;if(k&&k.fn&&k.fn.tap){j="tap"}if(this.captureLink==true){document.addEventListener(j,this.handleTapEvent);if(j=="tap"){document.addEventListener("click",function(o){var q=o.target;if(!q){return}if(q.tagName.toLowerCase()!="a"&&!(q=q.getParentElementByTag("a"))){return}var p=q.getAttribute("data-ajax"),n=q.href;if(q.getAttribute("data-rel")=="external"||p=="false"||(n.split("/")[0]!==location.href.split("/")[0]&&p!="true")||(b.captureLink==false&&p!="true")){return}o.preventDefault()})}}a=true};b.handleTapEvent=function(k){var r=k.target||k.touches[0],l=r.href;if((!l||/a/i.test(r.tagName)==false)&&(r=r.getParentElementByTag("a"))){l=r.href}var v=document.querySelector(".in."+b.classPage);if(v==null||!r){return}var j=r.getElementsByClassName(b.classMask)[0];if(j&&j.style.visibility!="hidden"){k.preventDefault();return false}var u=(b.captureLink==true);var w=r.getAttribute("data-rel");var n=false;if(w=="back"){n=true}var q=(w=="external");if(!l){return}if(r.getAttribute("href").replace(/#/g,"")===""){k.preventDefault();return}if(/^javascript/.test(l)){if(n==false){return}}else{q=q||(l.split("/")[0]!==location.href.split("/")[0]);if((q==true||u==false)&&r.getAttribute("data-ajax")!="true"){return}}if(/^#/.test(r.getAttribute("href"))==true){var p=l.split("#")[1],s=p&&document.getElementById(p);if(n==false&&w=="auto"){n=b.isBack(s,v)}if(s){b.transition(s,v,n)}k.preventDefault()}else{if(/^javascript/.test(l)){history.tempBack=true;history.back()}else{if(r.getAttribute("data-ajax")!="false"){var t=b.getCleanUrl(r);var o=r.getAttribute("data-reload"),m=r.getAttribute("href");if((o==null||o=="false")&&h[t]){if(n==false&&w=="auto"){n=b.isBack(h[m],v)}b.transition(h[m],v,n,{id:m})}else{b.ajax(r)}k.preventDefault()}}}};Element.prototype.getParentElementByTag=function(j){if(!j){return null}var l=null,m=this;var k=function(){m=m.parentElement;var n=m.tagName.toLowerCase();if(n===j){l=m}else{if(n=="body"){l=null}else{k()}}};k();return l};var c=function(j){var k={};if(typeof j=="string"){j.split("&").forEach(function(l){var m=l.split("=");if(m.length>1){k[m[0]]=l.replace(m[0]+"=","")}})}return k};window.addEventListener("DOMContentLoaded",function(){if(a==false){b.init()}});window.addEventListener("popstate",function(){var l=location.hash.replace("#&","").replace("#","");if(l==""||e.test(l)==false){return}var j=h[l]||document.querySelector("#"+l),k=document.querySelector(".in."+b.classPage);if((j&&j==k)||b.pushStateEnabled==false){return}if(j){b.transition(j,k,b.isBack(j,k),{history:false})}});return b});
